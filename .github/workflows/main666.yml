name: 'Live Source 1 Update with Multi-platform Sync'

on:
  schedule:
    - cron: '10 21 * * *'  # UTCæ—¶é—´è§¦å‘å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¹´1æœˆ1æ—¥21:10ï¼‰
  workflow_dispatch:
    inputs:
      # ==================== åŒæ­¥é…ç½® ====================
      sync_mode1:
        description: 'æ˜¯å¦å¯ç”¨å¤šå¹³å°åŒæ­¥'
        required: true
        type: boolean
        options:
          - 'true'
          - 'false'
        default: false
      sync_mode:
        
      target_repo:
        description: 'ç›®æ ‡ä»“åº“ï¼ˆæ ¼å¼ï¼šç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯ï¼‰'
        required: false
        default: 'xiaoran37/update@main'
        type: string
      target_folder:
        description: 'ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„'
        required: false
        default: 'output'
        type: string
       sync_mode:
        description: 'æ›´æ–°æ¨¡å¼'
        required: true
        type: choice
        options:
          - 'å¢é‡'
          - 'è¦†ç›–'
        default: 'å¢é‡'
      
      commit_message:
        description: 'æäº¤ä¿¡æ¯ï¼ˆå¯ç”¨å˜é‡ï¼š{time} {date} {source} {target}ï¼‰'
        required: false
        default: 'ğŸ”„ {date} {time}'
        type: string
        sync_mode:
        

env:
  PYTHON_VERSION: '3.10'
  RETAIN_DAYS: 7
  HISTORY_DIR: 'history/custom1'
  FILES_TO_ARCHIVE: >-
    output/custom1/full.txt
    output/custom1/simple.txt
    output/custom1/custom.txt
    output/custom1/others.txt
    output/custom1/sports.html
  # ==================== åŒæ­¥é»˜è®¤é…ç½® ====================
  SYNC_ENABLED: ${{ inputs.enable_sync || true }}
  SYNC_MODE: ${{ inputs.sync_mode || 'å¢é‡' }}
  TARGET_REPO: ${{ inputs.target_repo || 'xiaoran37/update@main' }}
  TARGET_FOLDER: ${{ inputs.target_folder || 'output' }}
  TARGET_TOKEN: 'XIAORAN37_GITHUB_TOKEN'
  TARGET_PLATFORM: 'github'

jobs:
  run_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # ==================== åŸæœ‰ç”Ÿæˆæµç¨‹ ====================
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main

      - name: å¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç 
        run: git fetch --prune && git reset --hard origin/main

      - name: å®‰è£…Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ç¼“å­˜ä¾èµ–åŒ…
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install opencc-python-reimplemented pytz || { 
            echo "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡"; 
            pip install opencc-python-reimplemented pytz; 
          }

      - name: åŒæ­¥ä»£ç å¹¶ç”Ÿæˆæ–‡ä»¶
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          mkdir -p output/custom1
          git reset --hard HEAD
          git pull origin main --rebase || { 
            echo "å˜åŸºå†²çªï¼Œè‡ªåŠ¨ç”¨è¿œç¨‹æœ€æ–°ä»£ç è¦†ç›–æœ¬åœ°";
            git rebase --abort;
            git pull origin main --force;
          }
          python scripts/LiveSource1.py || { 
            echo "é¦–æ¬¡ç”Ÿæˆå¤±è´¥ï¼Œé‡è¯•"; 
            python scripts/LiveSource1.py || { exit 1; } 
          }

      - name: æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
        run: |
          critical_files=("output/custom1/full.txt" "output/custom1/custom.txt")
          for file in "${critical_files[@]}"; do
            if [ ! -s "$file" ]; then
              echo "é”™è¯¯ï¼š$file å¼‚å¸¸ï¼Œç»ˆæ­¢æµç¨‹"; exit 1;
            fi
          done
          if ! grep -q "ğŸŒå¤®è§†é¢‘é“,#genre#" "output/custom1/full.txt"; then
            echo "é”™è¯¯ï¼šæ ¸å¿ƒå†…å®¹ç¼ºå¤±ï¼Œç»ˆæ­¢æµç¨‹"; exit 1;
          fi

      - name: æ¸…ç†å†å²å½’æ¡£ï¼ˆæŒ‰æ–‡ä»¶åæ—¥æœŸï¼‰
        run: |
          mkdir -p ${{ env.HISTORY_DIR }}
          retain_date=$(date -d "-${{ env.RETAIN_DAYS }} days" +"%Y%m%d")
          echo "ä¿ç•™æ—¥æœŸï¼š$retain_date åŠä¹‹åçš„å½’æ¡£"
          
          for zip_file in "${{ env.HISTORY_DIR }}"/*.zip; do
            [ -f "$zip_file" ] || continue
            file_date=$(basename "$zip_file" | cut -d'_' -f1)
            if [[ "$file_date" =~ ^[0-9]{8}$ ]]; then
              if [ "$file_date" -lt "$retain_date" ]; then
                echo "åˆ é™¤è¿‡æœŸå½’æ¡£ï¼š$zip_file"
                rm -f "$zip_file"
              else
                echo "ä¿ç•™å½’æ¡£ï¼š$zip_file"
              fi
            else
              echo "å¿½ç•¥éæ ‡å‡†å‘½åæ–‡ä»¶ï¼š$zip_file"
            fi
          done

      - name: ç”Ÿæˆä»Šæ—¥å½’æ¡£
        run: |
          if git diff --quiet ${{ env.FILES_TO_ARCHIVE }}; then
            echo "æ–‡ä»¶æœªä¿®æ”¹ï¼Œä¸ç”Ÿæˆæ–°å½’æ¡£";
          else
            current_datetime=$(date +"%Y%m%d_%H%M%S")
            zip_filename="${{ env.HISTORY_DIR }}/${current_datetime}_custom1.zip"
            zip -j "${zip_filename}" ${{ env.FILES_TO_ARCHIVE }}
            git add "${zip_filename}"
          fi

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          git add output/custom1/ ${{ env.HISTORY_DIR }}/
          git commit -m "ğŸ‰ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" || true
          git push origin main

      # ==================== å¤šå¹³å°åŒæ­¥åŠŸèƒ½ ====================
      - name: ğŸ”„ æ‰§è¡Œå¤šå¹³å°åŒæ­¥
        if: env.SYNC_ENABLED == 'true'
        run: |
          echo "=== å¼€å§‹å¤šå¹³å°åŒæ­¥ ==="
          echo "åŒæ­¥æ¨¡å¼: ${{ env.SYNC_MODE }}"
          echo "ç›®æ ‡ä»“åº“: ${{ env.TARGET_REPO }}"
          echo "ç›®æ ‡æ–‡ä»¶å¤¹: ${{ env.TARGET_FOLDER }}"

      - name: ğŸ§© è§£æåŒæ­¥é…ç½®
        if: env.SYNC_ENABLED == 'true'
        id: parse_sync_config
        run: |
          echo "=== è§£æåŒæ­¥é…ç½® ==="
          
          # è§£æç›®æ ‡ä»“åº“
          if echo "${{ env.TARGET_REPO }}" | grep -qE '^[a-zA-Z0-9-]+/[a-zA-Z0-9-]+@[a-zA-Z0-9-]+$'; then
            IFS='/@' read -r target_user target_repo target_branch <<< "${{ env.TARGET_REPO }}"
            echo "ç›®æ ‡ç”¨æˆ·: $target_user"
            echo "ç›®æ ‡ä»“åº“: $target_repo"
            echo "ç›®æ ‡åˆ†æ”¯: $target_branch"
            echo "target_user=$target_user" >> $GITHUB_ENV
            echo "target_repo=$target_repo" >> $GITHUB_ENV
            echo "target_branch=$target_branch" >> $GITHUB_ENV
          else
            echo "âŒ ç›®æ ‡ä»“åº“æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºï¼šç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯"
            exit 1
          fi

      - name: ğŸ”‘ æ ¡éªŒåŒæ­¥Token
        if: env.SYNC_ENABLED == 'true'
        run: |
          echo "=== æ ¡éªŒåŒæ­¥Token ==="
          if [ -z "${{ secrets[env.TARGET_TOKEN] }}" ]; then
            echo "âŒ ç›®æ ‡ä»“åº“Tokenä¸å­˜åœ¨: ${{ env.TARGET_TOKEN }}"
            exit 1
          fi
          echo "âœ… Tokenæ ¡éªŒé€šè¿‡"

      - name: ğŸ› ï¸ å®‰è£…åŒæ­¥å·¥å…·
        if: env.SYNC_ENABLED == 'true'
        run: |
          echo "=== å®‰è£…åŒæ­¥å·¥å…· ==="
          sudo apt-get update
          sudo apt-get install -y rsync tree
          echo "âœ… rsyncå®‰è£…å®Œæˆ"

      - name: ğŸ“¦ å‡†å¤‡ç›®æ ‡ä»“åº“
        if: env.SYNC_ENABLED == 'true'
        run: |
          echo "=== å‡†å¤‡ç›®æ ‡ä»“åº“ ==="
          TARGET_TOKEN="${{ secrets[env.TARGET_TOKEN] }}"
          
          # æ„å»ºç›®æ ‡ä»“åº“URL
          case "${{ env.TARGET_PLATFORM }}" in
            "github")
              TARGET_URL="https://${TARGET_TOKEN}@github.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
            "gitee")
              TARGET_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitee.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
            "gitcode")
              TARGET_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitcode.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
          esac
          
          echo "ç›®æ ‡ä»“åº“URL: $TARGET_URL"
          
          # å…‹éš†ç›®æ ‡ä»“åº“
          git clone --branch ${{ env.target_branch }} --depth=1 "$TARGET_URL" target_repo 2>/dev/null || {
            echo "âš ï¸ ç›®æ ‡ä»“åº“ä¸å­˜åœ¨æˆ–å…‹éš†å¤±è´¥ï¼Œå°è¯•åˆå§‹åŒ–..."
            mkdir -p target_repo
            cd target_repo
            git init
            git remote add origin "$TARGET_URL"
            git checkout -b ${{ env.target_branch }}
            cd ..
          }
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p "target_repo/${{ env.TARGET_FOLDER }}"
          echo "âœ… ç›®æ ‡ä»“åº“å‡†å¤‡å®Œæˆ"

      - name: ğŸ”„ æ‰§è¡Œæ–‡ä»¶åŒæ­¥
        if: env.SYNC_ENABLED == 'true'
        id: sync_files
        run: |
          echo "=== æ‰§è¡Œæ–‡ä»¶åŒæ­¥ ==="
          
          # æ„å»ºæºè·¯å¾„å’Œç›®æ ‡è·¯å¾„
          SOURCE_PATH="output/custom1"
          TARGET_PATH="target_repo/${{ env.TARGET_FOLDER }}"
          
          echo "æºè·¯å¾„: $SOURCE_PATH"
          echo "ç›®æ ‡è·¯å¾„: $TARGET_PATH"
          
          # æ£€æŸ¥æºè·¯å¾„æ˜¯å¦å­˜åœ¨
          if [ ! -d "$SOURCE_PATH" ]; then
            echo "âŒ æºè·¯å¾„ä¸å­˜åœ¨: $SOURCE_PATH"
            exit 1
          fi
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p "$TARGET_PATH"
          
          # æ ¹æ®åŒæ­¥æ¨¡å¼æ‰§è¡Œä¸åŒçš„rsyncå‘½ä»¤
          if [ "${{ env.SYNC_MODE }}" = "å¢é‡" ]; then
            echo "ğŸ”„ æ‰§è¡Œå¢é‡åŒæ­¥"
            rsync -rltvh --progress "$SOURCE_PATH"/ "$TARGET_PATH"/
          else
            echo "ğŸ”„ æ‰§è¡Œè¦†ç›–åŒæ­¥"
            rsync -rltvh --progress --delete "$SOURCE_PATH"/ "$TARGET_PATH"/
          fi
          
          echo "âœ… æ–‡ä»¶åŒæ­¥å®Œæˆ"
          
          # æ˜¾ç¤ºåŒæ­¥ç»“æœ
          echo "=== åŒæ­¥ç»“æœ ==="
          echo "æºç›®å½•å†…å®¹:"
          ls -la "$SOURCE_PATH" | head -10
          echo "..."
          echo "ç›®æ ‡ç›®å½•å†…å®¹:"
          ls -la "$TARGET_PATH" | head -10
          echo "..."

      - name: ğŸ” æ£€æŸ¥åŒæ­¥å˜åŒ–
        if: env.SYNC_ENABLED == 'true'
        id: check_sync_changes
        run: |
          echo "=== æ£€æŸ¥åŒæ­¥å˜åŒ– ==="
          cd target_repo
          
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ”„ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œéœ€è¦æäº¤"
            echo "sync_changes_detected=true" >> $GITHUB_OUTPUT
            
            echo "=== å…·ä½“å˜åŒ– ==="
            git status
            git diff --stat
          else
            echo "âœ… æ— æ–‡ä»¶å˜åŒ–ï¼Œæ— éœ€æäº¤"
            echo "sync_changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¤ æäº¤å¹¶æ¨é€åŒæ­¥æ›´æ”¹
        if: env.SYNC_ENABLED == 'true' && steps.check_sync_changes.outputs.sync_changes_detected == 'true'
        run: |
          echo "=== æäº¤åŒæ­¥æ›´æ”¹ ==="
          cd target_repo
          
          # é…ç½®Gitç”¨æˆ·
          git config user.name "Auto Sync Bot"
          git config user.email "sync-bot@noreply.github.com"
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%H:%M:%S')
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          COMMIT_MSG="ğŸ”„ è‡ªåŠ¨åŒæ­¥ $CURRENT_DATE $CURRENT_TIME - æ¥è‡ª ${{ github.repository }}"
          
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶å¹¶æäº¤
          git add -A
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€åˆ°ç›®æ ‡ä»“åº“
          echo "=== æ¨é€åˆ°ç›®æ ‡ä»“åº“ ==="
          TARGET_TOKEN="${{ secrets[env.TARGET_TOKEN] }}"
          
          case "${{ env.TARGET_PLATFORM }}" in
            "github")
              PUSH_URL="https://${TARGET_TOKEN}@github.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
            "gitee")
              PUSH_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitee.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
            "gitcode")
              PUSH_URL="https://${{ env.target_user }}:${TARGET_TOKEN}@gitcode.com/${{ env.target_user }}/${{ env.target_repo }}.git"
              ;;
          esac
          
          # æ ¹æ®åŒæ­¥æ¨¡å¼å†³å®šæ˜¯å¦å¼ºåˆ¶æ¨é€
          if [ "${{ env.SYNC_MODE }}" = "è¦†ç›–" ]; then
            echo "ğŸ”„ è¦†ç›–æ¨¡å¼ï¼Œä½¿ç”¨å¼ºåˆ¶æ¨é€"
            git push "$PUSH_URL" HEAD:${{ env.target_branch }} --force
          else
            echo "ğŸ”„ å¢é‡æ¨¡å¼ï¼Œä½¿ç”¨æ™®é€šæ¨é€"
            git push "$PUSH_URL" HEAD:${{ env.target_branch }}
          fi
          
          echo "âœ… åŒæ­¥æ¨é€å®Œæˆ"

      # ==================== æœ€ç»ˆæŠ¥å‘Šå’Œæ¸…ç† ====================
      - name: ğŸ“Š ç”Ÿæˆç»¼åˆæŠ¥å‘Š
        run: |
          echo "=== ğŸ‰ ç»¼åˆæ‰§è¡ŒæŠ¥å‘Š ==="
          echo ""
          echo "âœ… æ–‡ä»¶ç”Ÿæˆä»»åŠ¡å®Œæˆ"
          echo ""
          echo "ğŸ“Š ç”Ÿæˆç»“æœ:"
          echo "   ç”Ÿæˆæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "   ç”Ÿæˆæ–‡ä»¶: output/custom1/ ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶"
          echo "   å½’æ¡£æ–‡ä»¶: ${{ env.HISTORY_DIR }}/ ç›®å½•"
          echo ""
          
          if [ "${{ env.SYNC_ENABLED }}" = "true" ]; then
            echo "ğŸ”„ å¤šå¹³å°åŒæ­¥:"
            echo "   åŒæ­¥çŠ¶æ€: ${{ steps.check_sync_changes.outputs.sync_changes_detected == 'true' && 'å·²åŒæ­¥' || 'æ— å˜åŒ–' }}"
            echo "   åŒæ­¥æ¨¡å¼: ${{ env.SYNC_MODE }}"
            echo "   ç›®æ ‡ä»“åº“: ${{ env.TARGET_REPO }}"
            echo "   ç›®æ ‡å¹³å°: ${{ env.TARGET_PLATFORM }}"
          else
            echo "â¸ï¸ å¤šå¹³å°åŒæ­¥: å·²ç¦ç”¨"
          fi
          
          echo ""
          echo "=========================================="

      - name: ğŸ“¦ ä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶ä½œä¸ºartifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-files
          path: |
            output/custom1/full.txt
            output/custom1/full.m3u
            output/custom1/simple.txt
            output/custom1/simple.m3u
            output/custom1/others.txt
            output/custom1/sports.html
            output/custom1/custom.txt
            output/custom1/custom.m3u
            ${{ env.HISTORY_DIR }}/*.zip

      - name: ğŸš¨ é”™è¯¯å¤„ç†
        if: failure()
        run: |
          echo "=== âŒ æ‰§è¡Œå¤±è´¥ ==="
          echo "é”™è¯¯è¯¦æƒ…è¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—"
          echo ""
          echo "å¸¸è§é—®é¢˜æ’æŸ¥:"
          echo "1. æ£€æŸ¥Pythonè„šæœ¬æ‰§è¡Œæ˜¯å¦æ­£å¸¸"
          echo "2. æ£€æŸ¥æ–‡ä»¶ç”Ÿæˆæ˜¯å¦å®Œæ•´"
          echo "3. æ£€æŸ¥Gitæ“ä½œæƒé™"
          echo "4. æ£€æŸ¥åŒæ­¥Tokenæƒé™"
          exit 1
