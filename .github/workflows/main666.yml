name: 'Live Source 1 Update'

on:
  schedule:
    - cron: '10 21 * * *'  # UTCæ—¶é—´è§¦å‘å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¹´1æœˆ1æ—¥21:10ï¼‰
  workflow_dispatch:
    inputs:
      # ==================== åŸºç¡€é…ç½® ====================
      
      retain_days:
        description: 'Zipå½’æ¡£ä¿ç•™å¤©æ•°'
        required: false
        default: '7'
        type: number

      # ==================== å¤šå¹³å°åŒæ­¥é…ç½®ï¼ˆå¯é€‰ï¼‰ ====================
      enable_sync:
        description: 'å¯ç”¨å¤šå¹³å°åŒæ­¥ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: false
        type: boolean
      target_repo:
        description: 'ç›®æ ‡ä»“åº“ï¼ˆæ ¼å¼ï¼šç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯ï¼‰'
        required: false
        default: 'xiaoran67/update@main'
        type: string
      target_folder:
        description: 'ç›®æ ‡æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆå¤šçº§ç›®å½•ç”¨/åˆ†éš”ï¼Œç•™ç©º=æ ¹ç›®å½•ï¼‰'
        required: false
        default: 'output'
        type: string
      target_token:
        description: 'ç›®æ ‡ä»“åº“Tokençš„Secretåç§°'
        required: false
        default: 'XIAORAN67_GITHUB_TOKEN'
        type: string
      target_platform:
        description: 'ç›®æ ‡ä»“åº“å¹³å°'
        required: false
        type: choice
        options:
          - 'github'
          - 'gitee'
          - 'gitcode'
        default: 'github'
      sync_mode:
        description: 'åŒæ­¥æ¨¡å¼'
        required: false
        type: choice
        options:
          - 'å¢é‡'
          - 'è¦†ç›–'
        default: 'å¢é‡'
      commit_message:  # ä¿®å¤ï¼šæ­£ç¡®çš„ç¼©è¿›å±‚çº§
        description: 'æäº¤ä¿¡æ¯ï¼ˆå¯ç”¨å˜é‡ï¼š{time} {date} {source} {target}ï¼‰'
        required: false
        default: 'ğŸ”„ {date} {time}'
        type: string

env:
  PYTHON_VERSION: '3.10'        # ä½¿ç”¨çš„Pythonç‰ˆæœ¬
  DEFAULT_RETAIN_DAYS: 7        # é»˜è®¤å†å²å½’æ¡£æ–‡ä»¶ä¿ç•™å¤©æ•°
  HISTORY_DIR: 'history/custom1'  # å½’æ¡£ç›®å½•
  FILES_TO_ARCHIVE: >-          # éœ€è¦å½’æ¡£çš„æ–‡ä»¶åˆ—è¡¨
    output/custom1/full.txt
    output/custom1/simple.txt
    output/custom1/custom.txt
    output/custom1/others.txt
    output/custom1/sports.html

jobs:
  run_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # å…è®¸å†™å…¥ä»“åº“å†…å®¹
      pull-requests: write     # å…è®¸æ“ä½œPR

    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main  # æ‹‰å–mainåˆ†æ”¯ä»£ç 
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      - name: å¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç 
        run: |
          git fetch --prune 
          git reset --hard origin/main  # ç¡®ä¿æœ¬åœ°ä»£ç ä¸è¿œç¨‹ä¸€è‡´
          git clean -fd  # æ¸…ç†æœªè·Ÿè¸ªæ–‡ä»¶

      - name: å®‰è£…Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}  # ä½¿ç”¨æŒ‡å®šPythonç‰ˆæœ¬

      - name: ç¼“å­˜ä¾èµ–åŒ…
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip  # ç¼“å­˜pipä¾èµ–è·¯å¾„
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}  # ç¼“å­˜é”®å€¼
          restore-keys: |
            ${{ runner.os }}-pip-  # ç¼“å­˜æ¢å¤è§„åˆ™

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: |
          python -m pip install --upgrade pip  # å‡çº§pip
          # å®‰è£…æ ¸å¿ƒä¾èµ–ï¼Œå¤±è´¥æ—¶é‡è¯•ä¸€æ¬¡
          pip install opencc-python-reimplemented pytz || { 
            echo "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡"; 
            pip install opencc-python-reimplemented pytz; 
          }

      - name: é…ç½®Gitèº«ä»½
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"

      - name: ç”Ÿæˆæ–‡ä»¶
        run: |
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          mkdir -p output/custom1
          # æ‰§è¡Œscriptsç›®å½•ä¸‹çš„ç”Ÿæˆè„šæœ¬ï¼Œå¤±è´¥æ—¶é‡è¯•ä¸€æ¬¡
          python scripts/LiveSource1.py || { 
            echo "é¦–æ¬¡ç”Ÿæˆå¤±è´¥ï¼Œé‡è¯•"; 
            python scripts/LiveSource1.py || { 
              echo "ç”Ÿæˆæ–‡ä»¶å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"; 
              exit 1; 
            } 
          }

      - name: æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
        run: |
          # å®šä¹‰å…³é”®æ–‡ä»¶åˆ—è¡¨
          critical_files=("output/custom1/full.txt" "output/custom1/custom.txt")
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”éç©º
          for file in "${critical_files[@]}"; do
            if [ ! -s "$file" ]; then
              echo "é”™è¯¯ï¼š$file å¼‚å¸¸ï¼Œç»ˆæ­¢æµç¨‹"; exit 1;
            fi
          done
          # æ£€æŸ¥æ ¸å¿ƒå†…å®¹æ˜¯å¦å­˜åœ¨
          if ! grep -q "ğŸŒå¤®è§†é¢‘é“,#genre#" "output/custom1/full.txt"; then
            echo "é”™è¯¯ï¼šæ ¸å¿ƒå†…å®¹ç¼ºå¤±ï¼Œç»ˆæ­¢æµç¨‹"; exit 1;
          fi

      - name: è®¾ç½®åŠ¨æ€å˜é‡
        run: |
          if [ "${{ github.event.inputs.retain_days }}" != "" ]; then
            echo "RETAIN_DAYS=${{ github.event.inputs.retain_days }}" >> $GITHUB_ENV
          else
            echo "RETAIN_DAYS=${{ env.DEFAULT_RETAIN_DAYS }}" >> $GITHUB_ENV
          fi

          echo "é…ç½®è¯¦æƒ…ï¼š"
          echo "ä¿ç•™å¤©æ•°: $RETAIN_DAYS"
          echo "åŒæ­¥å¯ç”¨: ${{ github.event.inputs.enable_sync }}"

      - name: æ¸…ç†å†å²å½’æ¡£ï¼ˆæŒ‰æ–‡ä»¶åæ—¥æœŸï¼‰
        run: |
          mkdir -p ${{ env.HISTORY_DIR }}  # åˆ›å»ºhistory/custom1ç›®å½•
          # è®¡ç®—éœ€è¦ä¿ç•™çš„æœ€æ—©æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYYMMDDï¼‰
          retain_date=$(date -d "-${{ env.RETAIN_DAYS }} days" +"%Y%m%d")
          echo "ä¿ç•™æ—¥æœŸï¼š$retain_date åŠä¹‹åçš„å½’æ¡£"
          echo "å½“å‰æ—¥æœŸï¼š$(date +"%Y%m%d")"
          echo "å½’æ¡£ç›®å½•ï¼š${{ env.HISTORY_DIR }}"
          echo "ä¿ç•™å¤©æ•°ï¼š${{ env.RETAIN_DAYS }}"
          
          # éå†å½’æ¡£ç›®å½•ä¸‹çš„zipæ–‡ä»¶ï¼ŒæŒ‰æ–‡ä»¶åæ—¥æœŸåˆ é™¤è¿‡æœŸæ–‡ä»¶
          for zip_file in "${{ env.HISTORY_DIR }}"/*.zip; do
            # è·³è¿‡ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼ˆé˜²æ­¢ç›®å½•ä¸ºç©ºæ—¶æŠ¥é”™ï¼‰
            [ -f "$zip_file" ] || continue
            
            # ä»æ–‡ä»¶åä¸­æå–æ—¥æœŸéƒ¨åˆ†
            filename=$(basename "$zip_file")
            file_date=$(echo "$filename" | grep -o '^[0-9]\{8\}')
            
            # éªŒè¯æå–çš„æ—¥æœŸæ˜¯å¦ä¸º8ä½æ•°å­—
            if [ -n "$file_date" ] && [[ "$file_date" =~ ^[0-9]{8}$ ]]; then
              # æ¯”è¾ƒæ–‡ä»¶åæ—¥æœŸä¸ä¿ç•™æ—¥æœŸï¼Œåˆ é™¤æ—©äºä¿ç•™æ—¥æœŸçš„æ–‡ä»¶
              if [ "$file_date" -lt "$retain_date" ]; then
                echo "åˆ é™¤è¿‡æœŸå½’æ¡£ï¼š$filename (æ—¥æœŸ: $file_date < $retain_date)"
                rm -f "$zip_file"
              else
                echo "ä¿ç•™å½’æ¡£ï¼š$filename (æ—¥æœŸ: $file_date >= $retain_date)"
              fi
            else
              echo "å¿½ç•¥éæ ‡å‡†å‘½åæ–‡ä»¶ï¼š$filename"
            fi
          done
          echo "å†å²å½’æ¡£æ¸…ç†å®Œæˆ"

      - name: ç”Ÿæˆä»Šæ—¥å½’æ¡£
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹
          if git diff --quiet ${{ env.FILES_TO_ARCHIVE }}; then
            echo "æ–‡ä»¶æœªä¿®æ”¹ï¼Œä¸ç”Ÿæˆæ–°å½’æ¡£";
          else
            # å½’æ¡£æ–‡ä»¶ä¿å­˜åˆ°history/custom1
            current_datetime=$(date +"%Y%m%d_%H%M%S")
            zip_filename="${{ env.HISTORY_DIR }}/${current_datetime}_custom1.zip"
            zip -j "${zip_filename}" ${{ env.FILES_TO_ARCHIVE }}
            git add "${zip_filename}"
            echo "æ–°å½’æ¡£ç”Ÿæˆï¼š${zip_filename}"
          fi

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          # æ·»åŠ éœ€è¦æäº¤çš„æ–‡ä»¶
          git add output/custom1/ ${{ env.HISTORY_DIR }}/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
            exit 0
          fi
          
          # æäº¤ä¿®æ”¹
          git commit -m "ğŸ‰ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          
          # ä½¿ç”¨å®‰å…¨çš„æ–¹å¼æ¨é€ï¼Œé¿å…å†²çª
          git pull origin main --rebase --autostash
          git push origin main

      - name: å¤šå¹³å°åŒæ­¥æ¨é€ï¼ˆå¯é€‰ï¼‰
        if: ${{ github.event.inputs.enable_sync == 'true' && github.event.inputs.target_repo != '' }}
        run: |
          echo "=== å¼€å§‹å¤šå¹³å°åŒæ­¥ ==="
          
          # è§£æç›®æ ‡ä»“åº“ä¿¡æ¯
          TARGET_REPO="${{ github.event.inputs.target_repo }}"
          if echo "$TARGET_REPO" | grep -qE '^[a-zA-Z0-9-]+/[a-zA-Z0-9-]+@[a-zA-Z0-9-]+$'; then
            IFS='/@' read -r target_user target_repo_name target_branch <<< "$TARGET_REPO"
            echo "ç›®æ ‡ç”¨æˆ·: $target_user"
            echo "ç›®æ ‡ä»“åº“: $target_repo_name"
            echo "ç›®æ ‡åˆ†æ”¯: $target_branch"
          else
            echo "âŒ ç›®æ ‡ä»“åº“æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºï¼šç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯"
            exit 1
          fi

          # è·å–Token
          TARGET_TOKEN_SECRET="${{ github.event.inputs.target_token }}"
          TARGET_TOKEN="${{ secrets[github.event.inputs.target_token] }}"
          if [ -z "$TARGET_TOKEN" ]; then
            echo "âŒ ç›®æ ‡ä»“åº“Tokenä¸å­˜åœ¨: $TARGET_TOKEN_SECRET"
            exit 1
          fi

          # è®¾ç½®è·¯å¾„å˜é‡
          TARGET_FOLDER="${{ github.event.inputs.target_folder }}"
          SYNC_MODE="${{ github.event.inputs.sync_mode }}"
          TARGET_PLATFORM="${{ github.event.inputs.target_platform }}"
          COMMIT_MESSAGE="${{ github.event.inputs.commit_message }}"
          
          SOURCE_PATH="output/custom1"
          [ -n "$TARGET_FOLDER" ] && TARGET_PATH="$TARGET_FOLDER" || TARGET_PATH="."
          
          echo "æºè·¯å¾„: $SOURCE_PATH"
          echo "ç›®æ ‡è·¯å¾„: $TARGET_PATH"
          echo "åŒæ­¥æ¨¡å¼: $SYNC_MODE"
          echo "ç›®æ ‡å¹³å°: $TARGET_PLATFORM"
          echo "æäº¤ä¿¡æ¯: $COMMIT_MESSAGE"

          # å®‰è£…å¿…è¦å·¥å…·
          sudo apt-get update
          sudo apt-get install -y curl jq

          # æ„å»ºç›®æ ‡ä»“åº“URLå’ŒAPIä¿¡æ¯
          case "$TARGET_PLATFORM" in
            "github")
              TARGET_URL="https://${TARGET_TOKEN}@github.com/$target_user/$target_repo_name.git"
              API_BASE="https://api.github.com"
              ;;
            "gitee")
              TARGET_URL="https://$target_user:${TARGET_TOKEN}@gitee.com/$target_user/$target_repo_name.git"
              API_BASE="https://gitee.com/api/v5"
              ;;
            "gitcode")
              TARGET_URL="https://$target_user:${TARGET_TOKEN}@gitcode.com/$target_user/$target_repo_name.git"
              API_BASE="https://gitcode.com/api/v4"
              ;;
          esac
          
          echo "ç›®æ ‡ä»“åº“URL: $TARGET_URL"
          echo "APIåŸºç¡€åœ°å€: $API_BASE"

          # æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º
          echo "=== æ£€æŸ¥ç›®æ ‡ä»“åº“ ==="
          case "$TARGET_PLATFORM" in
            "github")
              REPO_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $TARGET_TOKEN" "$API_BASE/repos/$target_user/$target_repo_name")
              ;;
            "gitee")
              REPO_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X GET "$API_BASE/repos/$target_user/$target_repo_name?access_token=$TARGET_TOKEN")
              ;;
            "gitcode")
              REPO_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "PRIVATE-TOKEN: $TARGET_TOKEN" "$API_BASE/projects/$target_user%2F$target_repo_name")
              ;;
          esac

          if [ "$REPO_STATUS" = "404" ] || [ "$REPO_STATUS" = "403" ]; then
            echo "âš ï¸ ç›®æ ‡ä»“åº“ä¸å­˜åœ¨ï¼Œå°è¯•è‡ªåŠ¨åˆ›å»º..."
            
            case "$TARGET_PLATFORM" in
              "github")
                CREATE_RESPONSE=$(curl -s -w "%{http_code}" -H "Authorization: token $TARGET_TOKEN" -H "Accept: application/vnd.github.v3+json" -X POST "$API_BASE/user/repos" -d "{\"name\":\"$target_repo_name\",\"private\":false}")
                HTTP_CODE="${CREATE_RESPONSE: -3}"
                RESPONSE_BODY="${CREATE_RESPONSE%???}"
                ;;
              "gitee")
                CREATE_RESPONSE=$(curl -s -w "%{http_code}" -X POST "$API_BASE/user/repos?access_token=$TARGET_TOKEN" -d "{\"name\":\"$target_repo_name\",\"private\":false}")
                HTTP_CODE="${CREATE_RESPONSE: -3}"
                RESPONSE_BODY="${CREATE_RESPONSE%???}"
                ;;
              "gitcode")
                CREATE_RESPONSE=$(curl -s -w "%{http_code}" -H "PRIVATE-TOKEN: $TARGET_TOKEN" -H "Content-Type: application/json" -X POST "$API_BASE/projects" -d "{\"name\":\"$target_repo_name\",\"visibility\":\"public\"}")
                HTTP_CODE="${CREATE_RESPONSE: -3}"
                RESPONSE_BODY="${CREATE_RESPONSE%???}"
                ;;
            esac

            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… ä»“åº“åˆ›å»ºæˆåŠŸ"
              # ç­‰å¾…ä»“åº“å®Œå…¨åˆ›å»º
              sleep 10
            else
              echo "âŒ ä»“åº“åˆ›å»ºå¤±è´¥: $HTTP_CODE"
              echo "å“åº”: $RESPONSE_BODY"
              exit 1
            fi
          elif [ "$REPO_STATUS" = "200" ]; then
            echo "âœ… ç›®æ ‡ä»“åº“å·²å­˜åœ¨"
          else
            echo "âŒ æ£€æŸ¥ä»“åº“çŠ¶æ€å¤±è´¥: $REPO_STATUS"
            exit 1
          fi

          # å…‹éš†ç›®æ ‡ä»“åº“
          echo "=== å…‹éš†ç›®æ ‡ä»“åº“ ==="
          git clone --branch "$target_branch" --depth 1 "$TARGET_URL" target_repo || {
            # å¦‚æœåˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†æ”¯
            echo "åˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†æ”¯: $target_branch"
            git clone --depth 1 "$TARGET_URL" target_repo
            cd target_repo
            git checkout -b "$target_branch"
            cd ..
          }

          # å‡†å¤‡åŒæ­¥æ–‡ä»¶
          echo "=== å‡†å¤‡åŒæ­¥æ–‡ä»¶ ==="
          cd target_repo
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p "$TARGET_PATH"
          
          # å¤„ç†æäº¤ä¿¡æ¯ä¸­çš„å˜é‡
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%H:%M:%S')
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          FINAL_COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | sed \
            -e "s/{time}/$CURRENT_TIME/g" \
            -e "s/{date}/$CURRENT_DATE/g" \
            -e "s/{source}/${{ github.repository }}/g" \
            -e "s/{target}/$target_user\\/$target_repo_name/g")
          
          echo "æœ€ç»ˆæäº¤ä¿¡æ¯: $FINAL_COMMIT_MESSAGE"

          # æ ¹æ®åŒæ­¥æ¨¡å¼å¤„ç†æ–‡ä»¶
          if [ "$SYNC_MODE" = "è¦†ç›–" ]; then
            echo "æ¨¡å¼: è¦†ç›– - æ¸…ç©ºç›®æ ‡ç›®å½•"
            rm -rf "${TARGET_PATH:?}"/*
            cp -r ../"$SOURCE_PATH"/* "$TARGET_PATH"/
          else
            echo "æ¨¡å¼: å¢é‡ - åˆå¹¶æ–‡ä»¶"
            cp -r ../"$SOURCE_PATH"/* "$TARGET_PATH"/
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if git diff --quiet; then
            echo "æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡åŒæ­¥"
            exit 0
          fi

          # æäº¤å’Œæ¨é€
          echo "=== æäº¤å’Œæ¨é€ ==="
          git add .
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git commit -m "$FINAL_COMMIT_MESSAGE"
          
          # æ¨é€æ›´æ”¹
          if git push origin "$target_branch"; then
            echo "âœ… åŒæ­¥æˆåŠŸ"
          else
            echo "âŒ åŒæ­¥å¤±è´¥"
            exit 1
          fi
