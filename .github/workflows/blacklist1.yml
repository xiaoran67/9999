name: Whitelist Blacklist Automation
on:
  workflow_dispatch:

jobs:
  check_live_sources:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: ğŸ”„ Sync Latest Code
        run: git fetch --prune && git reset --hard origin/main

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install Dependencies
        run: sudo apt update && sudo apt install -y ffmpeg

      - name: ğŸ” Execute Detection Script
        run: python assets/blacklist1/blacklist1.py

      - name: ğŸ’¾ Commit Results
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          git add assets/blacklist1/whitelist_auto.txt
          git add assets/blacklist1/whitelist_auto_tv.txt
          git add assets/blacklist1/blacklist_auto.txt
          git add assets/blacklist1/history/blacklist/*.txt
          git add assets/blacklist1/blackhost/*.txt
          git add -f assets/blacklist1/url_statistics.log
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes detected"
            exit 0
          fi
          
          git commit -m "ğŸ›¡ï¸ $(date +'%Y-%m-%d %H:%M:%S')"
          
          git pull origin main --rebase --autostash || {
            echo "ğŸ”„ Rebase failed, force syncing"
            git reset --hard origin/main
          }
          
          git push origin main --force-with-lease || git push origin main --force
          echo "âœ… Results pushed successfully"