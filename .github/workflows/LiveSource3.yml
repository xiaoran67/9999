name: 'Live Source 3 Update'

on:
  schedule:
    - cron: '30 21 1 1 *'  # è§¦å‘æ—¶é—´ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '30 09 1 1 *'  # è§¦å‘æ—¶é—´ï¼ˆUTCæ—¶é—´ï¼‰
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'  # æ‰‹åŠ¨è§¦å‘æ—¶çš„é»˜è®¤ç¯å¢ƒ

env:
  PYTHON_VERSION: '3.10'        # æŒ‡å®šä½¿ç”¨çš„Pythonç‰ˆæœ¬
  RETAIN_DAYS: 7                # å†å²å½’æ¡£æ–‡ä»¶ä¿ç•™å¤©æ•°
  HISTORY_DIR: 'history/livesource3'        # å†å²å½’æ¡£æ–‡ä»¶å­˜å‚¨ç›®å½•
  FILES_TO_ARCHIVE: >-          # éœ€è¦å½’æ¡£çš„æ–‡ä»¶åˆ—è¡¨
    output/livesource3/full.txt
    output/livesource3/lite.txt
    output/livesource3/others.txt
    output/livesource3/sports.html
    output/livesource3/custom.txt

jobs:
  run_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # å…è®¸å†™å…¥ä»“åº“å†…å®¹
      pull-requests: write     # å…è®¸æ“ä½œPull Requests

    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main  # æ‹‰å–mainåˆ†æ”¯ä»£ç 

      - name: å¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç 
        run: git fetch --prune && git reset --hard origin/main  # ç¡®ä¿æœ¬åœ°ä»£ç ä¸è¿œç¨‹å®Œå…¨ä¸€è‡´ï¼ˆåº”å¯¹ä»“åº“é‡å»ºï¼‰

      - name: å®‰è£…Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}  # é…ç½®æŒ‡å®šç‰ˆæœ¬çš„Pythonç¯å¢ƒ

      - name: ç¼“å­˜ä¾èµ–åŒ…
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip  # ç¼“å­˜pipä¾èµ–çš„è·¯å¾„
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}  # ç¼“å­˜é”®ï¼ˆåŸºäºä¾èµ–æ–‡ä»¶å“ˆå¸Œï¼‰
          restore-keys: |
            ${{ runner.os }}-pip-  # ç¼“å­˜æ¢å¤è§„åˆ™

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip  # å‡çº§pipå·¥å…·
          # å®‰è£…æ ¸å¿ƒä¾èµ–åŒ…ï¼Œå¤±è´¥æ—¶é‡è¯•ä¸€æ¬¡
          pip install opencc-python-reimplemented pytz || { 
            echo "ä¾èµ–å®‰è£…å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡"; 
            pip install opencc-python-reimplemented pytz; 
          }

      - name: åŒæ­¥ä»£ç å¹¶ç”Ÿæˆæ–‡ä»¶
        run: |
          # é…ç½®Gitæäº¤èº«ä»½ä¿¡æ¯
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git reset --hard HEAD  # é‡ç½®æœ¬åœ°æœªæäº¤çš„ä¿®æ”¹
          # æ‹‰å–è¿œç¨‹æ›´æ–°ï¼Œå¤„ç†å¯èƒ½çš„å†²çª
          git pull origin main --rebase || { 
            echo "å˜åŸºå†²çªï¼Œè‡ªåŠ¨ç”¨è¿œç¨‹æœ€æ–°ä»£ç è¦†ç›–æœ¬åœ°";
            git rebase --abort;
            git pull origin main --force;
          }
          # æ‰§è¡Œä¸»è„šæœ¬ç”Ÿæˆæ–‡ä»¶ï¼Œå¤±è´¥æ—¶é‡è¯•ä¸€æ¬¡
          python scripts/livesource3/livesource3.py || { 
            echo "é¦–æ¬¡ç”Ÿæˆæ–‡ä»¶å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡"; 
            python scripts/livesource3/livesource3.py || { 
              echo "ç”Ÿæˆæ–‡ä»¶å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"; 
              exit 1; 
            } 
          }

      - name: æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§
        run: |
          # å®šä¹‰éœ€è¦æ ¡éªŒçš„å…³é”®æ–‡ä»¶åˆ—è¡¨
          critical_files=("output/livesource3/full.txt" "output/livesource3/custom.txt")
          # æ£€æŸ¥æ¯ä¸ªå…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”éç©º
          for file in "${critical_files[@]}"; do
            if [ ! -s "$file" ]; then
              echo "é”™è¯¯ï¼š$file ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œç»ˆæ­¢æäº¤";
              exit 1;
            fi
          done
          # æ£€æŸ¥æ ¸å¿ƒåˆ†ç±»å†…å®¹æ˜¯å¦å­˜åœ¨
          if ! grep -q "ğŸŒå¤®è§†é¢‘é“,#genre#" "output/livesource3/custom.txt"; then
            echo "é”™è¯¯ï¼šoutput/livesource3/custom.txt ç¼ºå¤±å…³é”®åˆ†ç±»ï¼Œç»ˆæ­¢æäº¤";
            exit 1;
          fi

      - name: æ¸…ç†å†å²å½’æ¡£ï¼ˆæŒ‰æ–‡ä»¶åæ—¥æœŸï¼‰
        run: |
          mkdir -p ${{ env.HISTORY_DIR }}  # ç¡®ä¿å½’æ¡£ç›®å½•å­˜åœ¨
          # è®¡ç®—éœ€è¦ä¿ç•™çš„æœ€æ—©æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYYMMDDï¼‰
          retain_date=$(date -d "-${{ env.RETAIN_DAYS }} days" +"%Y%m%d")
          echo "ä¿ç•™æ—¥æœŸï¼š$retain_date åŠä¹‹åçš„å½’æ¡£"
          echo "å½“å‰æ—¥æœŸï¼š$(date +"%Y%m%d")"
          echo "å½’æ¡£ç›®å½•ï¼š${{ env.HISTORY_DIR }}"
          
          # éå†å½’æ¡£ç›®å½•ä¸‹çš„zipæ–‡ä»¶ï¼ŒæŒ‰æ–‡ä»¶åå‰8ä½æ—¥æœŸåˆ é™¤è¿‡æœŸæ–‡ä»¶
          for zip_file in "${{ env.HISTORY_DIR }}"/livesource3*.zip; do
            # è·³è¿‡ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼ˆé˜²æ­¢ç›®å½•ä¸ºç©ºæ—¶æŠ¥é”™ï¼‰
            [ -f "$zip_file" ] || continue
            
            # è·å–æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰
            filename=$(basename "$zip_file")
            
            # ä»æ–‡ä»¶åä¸­æå–å‰8ä½æ—¥æœŸéƒ¨åˆ†ï¼ˆå¦‚20251108ï¼‰
            file_date=$(echo "$filename" | grep -o '^[0-9]\{8\}')
            
            if [ -n "$file_date" ] && [[ "$file_date" =~ ^[0-9]{8}$ ]]; then
              # æ¯”è¾ƒæ–‡ä»¶åæ—¥æœŸä¸ä¿ç•™æ—¥æœŸï¼Œåˆ é™¤æ—©äºä¿ç•™æ—¥æœŸçš„æ–‡ä»¶
              if [ "$file_date" -lt "$retain_date" ]; then
                echo "åˆ é™¤è¿‡æœŸå½’æ¡£ï¼š$filename (æ—¥æœŸ: $file_date < $retain_date)"
                rm -f "$zip_file"
              else
                echo "ä¿ç•™å½’æ¡£ï¼š$filename (æ—¥æœŸ: $file_date >= $retain_date)"
              fi
            else
              echo "å¿½ç•¥éæ ‡å‡†å‘½åæ–‡ä»¶ï¼š$filename"
            fi
          done
          echo "å†å²å½’æ¡£æ¸…ç†å®Œæˆ"

      - name: ç”Ÿæˆä»Šæ—¥å½’æ¡£
        run: |
          # æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦æœ‰ä¿®æ”¹
          if git diff --quiet ${{ env.FILES_TO_ARCHIVE }}; then
            echo "æ–‡ä»¶æœªä¿®æ”¹ï¼Œä¸ç”Ÿæˆæ–°å½’æ¡£";
          else
            # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å½’æ¡£æ–‡ä»¶
            current_datetime=$(date +"%Y%m%d_%H%M%S")
            zip_filename="${{ env.HISTORY_DIR }}/${current_datetime}_livesource3.zip"
            zip -j "${zip_filename}" ${{ env.FILES_TO_ARCHIVE }}  # æ‰“åŒ…æ–‡ä»¶ï¼ˆä¸ä¿ç•™ç›®å½•ç»“æ„ï¼‰
            git add "${zip_filename}"  # å°†å½’æ¡£æ–‡ä»¶åŠ å…¥ç‰ˆæœ¬æ§åˆ¶
            echo "æ–°å½’æ¡£ç”Ÿæˆï¼š${zip_filename}"
          fi

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          # æ·»åŠ éœ€è¦æäº¤çš„æ–‡ä»¶ï¼ˆç”Ÿæˆç»“æœå’Œå½’æ¡£æ–‡ä»¶ï¼‰
          git add output/livesource3/full.txt output/livesource3/full.m3u output/livesource3/lite.txt output/livesource3/lite.m3u output/livesource3/others.txt output/livesource3/sports.html output/livesource3/custom.txt output/livesource3/custom.m3u ${{ env.HISTORY_DIR }}/
          # æäº¤ä¿®æ”¹ï¼ˆæ— ä¿®æ”¹æ—¶ä¸æŠ¥é”™ï¼‰
          git commit -m "ğŸ¦œ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')" || echo "æ— ä¸»æ–‡ä»¶ä¿®æ”¹éœ€æäº¤"
          # æ‹‰å–è¿œç¨‹æ›´æ–°å¹¶å¤„ç†å†²çª
          git pull origin main --rebase --autostash --allow-unrelated-histories || git pull origin main --force
          # æ¨é€ä¿®æ”¹ï¼Œä¼˜å…ˆå®‰å…¨æ¨é€ï¼Œå¤±è´¥æ—¶å¼ºåˆ¶æ¨é€
          git push origin main --force-with-lease || git push origin main --force

      - name: ä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: generated-files  #  artifactsåç§°
          path: |  # éœ€è¦ä¿å­˜çš„ç”Ÿæˆæ–‡ä»¶å’Œå½’æ¡£æ–‡ä»¶
            output/livesource3/full.txt
            output/livesource3/full.m3u
            output/livesource3/lite.txt
            output/livesource3/lite.m3u
            output/livesource3/others.txt
            output/livesource3/sports.html
            output/livesource3/custom.txt
            output/livesource3/custom.m3u
            ${{ env.HISTORY_DIR }}/*.zip
